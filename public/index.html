<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M4GIX HUB v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap');
        body { background-color: #0b0f1a; color: #e2e8f0; font-family: 'Inter', sans-serif; font-size: 13px; }
        .card { background-color: #111827; border: 1px solid #1f2937; }
        .search-input { background: #0f172a; border: 1px solid #334155; }
        .view-btn-active { background-color: #3b82f6; color: white; }
        #notification-container { position: fixed; bottom: 15px; right: 15px; z-index: 9999; }
        .toast { background: #1f2937; border-left: 4px solid #3b82f6; padding: 8px 15px; margin-top: 5px; border-radius: 4px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #374151; }
    </style>
</head>
<body class="p-4">

    <div id="notification-container"></div>

    <header class="flex flex-wrap justify-between items-center gap-4 mb-6">
        <div class="flex items-center gap-3">
            <h1 class="text-xl font-black text-blue-500 italic">M4GIX <span class="text-white">DB</span></h1>
            <div class="flex border border-slate-800 rounded p-0.5 bg-black/50">
                <button onclick="setView('cards')" id="btn-cards" class="px-3 py-1 text-[10px] font-bold uppercase rounded view-btn-active">Cards</button>
                <button onclick="setView('list')" id="btn-list" class="px-3 py-1 text-[10px] font-bold uppercase rounded text-slate-500">List</button>
            </div>
        </div>
        
        <input type="text" id="global-search" oninput="applyFilter()" placeholder="Filter collection..." 
               class="search-input flex-1 max-w-md px-3 py-1.5 rounded text-xs focus:border-blue-500 outline-none">

        <button onclick="clearDB()" class="text-[10px] text-red-500 font-bold hover:bg-red-500/10 px-2 py-1 rounded">CLEAR ALL</button>
    </header>

    <div class="flex gap-4 mb-6">
        <div class="bg-blue-600/5 border border-blue-600/20 px-4 py-2 rounded">
            <span class="text-[9px] text-slate-500 uppercase font-bold">Players</span>
            <div id="player-count" class="text-lg font-black leading-none">0</div>
        </div>
        <div class="bg-emerald-600/5 border border-emerald-600/20 px-4 py-2 rounded">
            <span class="text-[9px] text-slate-500 uppercase font-bold">Total Income</span>
            <div id="total-income-all" class="text-lg font-black leading-none text-emerald-400">$0/s</div>
        </div>
    </div>

    <main id="main-display"></main>

    <script>
        let allPlayers = [];
        let currentView = 'cards';
        let sortConfig = { key: 'Income', direction: 'desc' };

        // Formattage Argent
        const fM = (v) => {
            if (v >= 1e12) return (v/1e12).toFixed(1) + "T";
            if (v >= 1e9) return (v/1e9).toFixed(1) + "B";
            if (v >= 1e6) return (v/1e6).toFixed(1) + "M";
            if (v >= 1e3) return (v/1e3).toFixed(1) + "K";
            return v.toFixed(1);
        };

        const notify = (m) => {
            const c = document.getElementById('notification-container');
            const t = document.createElement('div');
            t.className = 'toast text-[11px]';
            t.innerHTML = m;
            c.appendChild(t);
            setTimeout(() => { t.remove() }, 3000);
        };

        const ws = new WebSocket(`${window.location.protocol === 'https:' ? 'wss' : 'ws'}://${window.location.host}`);
        ws.onmessage = (e) => {
            const p = JSON.parse(e.data);
            if (p.type === 'REFRESH') {
                if (p.data.length > allPlayers.length && allPlayers.length > 0) notify("➕ New Player Detected");
                allPlayers = p.data;
                applyFilter();
            }
        };

        function setView(v) {
            currentView = v;
            document.getElementById('btn-cards').className = `px-3 py-1 text-[10px] font-bold uppercase rounded ${v==='cards'?'view-btn-active':'text-slate-500'}`;
            document.getElementById('btn-list').className = `px-3 py-1 text-[10px] font-bold uppercase rounded ${v==='list'?'view-btn-active':'text-slate-500'}`;
            applyFilter();
        }

        function applyFilter() {
            const q = document.getElementById('global-search').value.toLowerCase();
            const filtered = allPlayers.filter(p => 
                p.name.toLowerCase().includes(q) || p.displayName.toLowerCase().includes(q) ||
                (p.brainrots || []).some(b => b.Name.toLowerCase().includes(q) || b.Rarity.toLowerCase().includes(q) || b.Mutation.toLowerCase().includes(q))
            );
            currentView === 'cards' ? renderCards(filtered) : renderList(filtered);
        }

        function renderCards(players) {
            document.getElementById('player-count').innerText = players.length;
            let globalIncome = 0;
            
            const html = players.map(p => {
                const pIncome = (p.brainrots || []).reduce((s, b) => s + (b.Income || 0), 0);
                globalIncome += pIncome;
                return `
                <div class="card p-3 rounded-md flex flex-col gap-2 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-1 bg-blue-500/10 text-[8px] font-bold text-blue-400">#${(p.brainrots || []).length} UNITS</div>
                    <div class="border-b border-slate-800 pb-2">
                        <div class="font-black text-blue-400 text-sm truncate">${p.displayName}</div>
                        <div class="text-[9px] text-slate-500 flex justify-between">
                            <span>@${p.name} (${p.accountAge}d)</span>
                            <span class="text-emerald-500 font-bold">$${fM(pIncome)}/s</span>
                        </div>
                    </div>
                    <div class="space-y-1 max-h-48 overflow-y-auto pr-1">
                        ${(p.brainrots || []).sort((a,b)=>b.Income-a.Income).map(b => `
                            <div class="bg-black/40 p-1.5 rounded text-[10px] border border-slate-800/50">
                                <div class="flex justify-between font-bold mb-0.5">
                                    <span class="text-slate-200 uppercase">${b.Name}</span>
                                    <span class="text-emerald-400">$${fM(b.Income)}</span>
                                </div>
                                <div class="flex flex-wrap gap-1 items-center">
                                    <span class="text-[8px] text-purple-400 uppercase font-bold">${b.Mutation}</span>
                                    <span class="px-1 bg-slate-800 rounded text-[7px] text-slate-400 uppercase">${b.Rarity}</span>
                                    ${(b.Traits || []).map(t => `<span class="text-[7px] text-blue-300 italic">· ${t}</span>`).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="deletePlayer(${p.userId})" class="mt-2 text-[8px] text-slate-600 hover:text-red-500 text-right uppercase font-bold tracking-widest">Delete Profile</button>
                </div>`;
            }).join('');
            
            document.getElementById('total-income-all').innerText = `$${fM(globalIncome)}/s`;
            document.getElementById('main-display').innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">${html}</div>`;
        }

        function renderList(players) {
            const list = [];
            players.forEach(p => (p.brainrots || []).forEach(b => list.push({...b, pName: p.displayName})));
            list.sort((a,b) => b.Income - a.Income);
            
            document.getElementById('main-display').innerHTML = `
            <div class="overflow-x-auto rounded border border-slate-800 bg-[#111827]">
                <table class="w-full text-left text-[11px]">
                    <thead class="bg-black/50 text-slate-500 uppercase font-bold">
                        <tr>
                            <th class="p-2">Owner</th><th class="p-2">Name</th><th class="p-2">Mutation</th>
                            <th class="p-2">Rarity</th><th class="p-2">Traits</th><th class="p-2">Income</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-800/50">
                        ${list.map(b => `
                            <tr class="hover:bg-blue-600/5">
                                <td class="p-2 font-bold text-blue-400">${b.pName}</td>
                                <td class="p-2 text-white uppercase font-bold">${b.Name}</td>
                                <td class="p-2 text-purple-400">${b.Mutation}</td>
                                <td class="p-2 text-slate-400 uppercase">${b.Rarity}</td>
                                <td class="p-2 text-slate-500 italic">${(b.Traits||[]).join(', ')}</td>
                                <td class="p-2 font-mono text-emerald-400 font-bold">$${fM(b.Income)}/s</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>`;
        }

        async function deletePlayer(id) { if(confirm("Delete?")) await fetch(`/api/client/${id}`, {method:'DELETE'}); }
        async function clearDB() { if(confirm("Clear?")) await fetch('/api/clear-database', {method:'POST'}); }
    </script>
</body>
</html>
