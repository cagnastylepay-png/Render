<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M4GIX - Global Grid & Teleporter</title>
    <style>
        :root { --accent: #00ff00; --bg: #0a0a0a; --card: #161616; --text: #eee; --local: #00d9ff; --private: #ffaa00; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; }
        
        .nav { 
            background: #111; padding: 15px; display: flex; justify-content: center; gap: 20px; 
            border-bottom: 2px solid var(--accent); position: sticky; top: 0; z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .btn { 
            background: #222; color: white; border: 1px solid #444; padding: 10px 25px; 
            cursor: pointer; border-radius: 6px; font-weight: bold; transition: 0.2s;
        }
        .btn.active { background: var(--accent); color: black; border-color: var(--accent); }
        .btn:hover:not(.active) { border-color: var(--accent); }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 30px; }
        
        .card { 
            background: var(--card); border: 1px solid #333; border-radius: 12px; padding: 20px; 
            display: flex; flex-direction: column; transition: 0.2s; position: relative;
        }
        .card.is-local { border: 1px dashed var(--local); box-shadow: 0 0 15px rgba(0, 217, 255, 0.05); }
        .card:hover { transform: translateY(-5px); border-color: var(--accent); }

        .income { 
            background: var(--accent); color: black; padding: 6px 12px; border-radius: 6px; 
            font-weight: 900; font-family: monospace; font-size: 1.2em; width: fit-content; margin-bottom: 10px; 
        }
        .rarity { font-size: 0.75em; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .Legendary { color: #ffff55; } .Epic { color: #ff55ff; } .Rare { color: #5555ff; } .Common { color: #888; }
        
        .name { font-size: 1.3em; font-weight: bold; color: #fff; }
        .mutation { color: #ff00ff; font-size: 0.85em; font-style: italic; margin-bottom: 12px; }
        
        .traits-list { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; min-height: 25px; }
        .trait-tag { background: rgba(0, 217, 255, 0.1); color: var(--local); font-size: 0.7em; padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(0, 217, 255, 0.2); }

        .footer { font-size: 0.8em; color: #777; margin-top: auto; padding-top: 15px; border-top: 1px solid #282828; line-height: 1.6; }
        .timestamp { color: var(--accent); font-weight: bold; font-size: 0.85em; margin-bottom: 5px; display: block; }
        
        /* Badges */
        .badge { font-size: 0.7em; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 5px; text-transform: uppercase; }
        .badge-user { background: #333; color: #fff; float: right; }
        .badge-local { background: var(--local); color: #000; float: right; }
        .badge-private { background: var(--private); color: #000; }
        .badge-public { background: #444; color: #fff; }
        
        .server-info { color: #aaa; display: block; margin-top: 5px; font-family: monospace; }

        .join-btn {
            margin-top: 12px; background: #1a1a1a; border: 1px solid var(--accent); color: var(--accent);
            padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; text-align: center;
            text-decoration: none; display: block; transition: 0.2s;
        }
        .join-btn:hover { background: var(--accent); color: black; }
    </style>
</head>
<body>

    <div class="nav">
        <button class="btn active" onclick="setFilter('ALL', this)">GLOBAL GRID</button>
        <button class="btn" onclick="setFilter('LOCAL', this)">MY ACCOUNTS</button>
        <div id="status" style="align-self: center; font-size: 0.8em; color: #555; font-weight: bold;">CONNECTING...</div>
    </div>

    <div id="grid" class="grid"></div>

    <script>
        let currentFilter = 'ALL';
        let brainrots = [];
        const gridElement = document.getElementById('grid');
        const statusElement = document.getElementById('status');

        const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${protocol}//${location.host}?role=Admin`);

        ws.onopen = () => { statusElement.innerText = "LIVE"; statusElement.style.color = "#00ff00"; };
        ws.onclose = () => { statusElement.innerText = "OFFLINE"; statusElement.style.color = "#ff4444"; };

        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            if (msg.type === 'REFRESH') {
                brainrots = msg.data;
                render();
            }
        };

        function timeAgo(dateString) {
            const now = new Date();
            const past = new Date(dateString);
            const diffSeconds = Math.floor((now - past) / 1000);
            if (diffSeconds < 5) return "√Ä l'instant";
            if (diffSeconds < 60) return `Il y a ${diffSeconds}s`;
            return `Il y a ${Math.floor(diffSeconds/60)}m`;
        }

        function setFilter(f, btn) {
            currentFilter = f;
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            render();
        }

        function render() {
            const filtered = currentFilter === 'LOCAL' 
                ? brainrots.filter(b => b.userType === 'LocalPlayer') 
                : brainrots;

            gridElement.innerHTML = filtered.map(b => {
                // Gestion s√©curit√© si les donn√©es server sont absentes (vieux logs)
                const s = b.server || { PlayerCount: '?', MaxPlayers: '?', IsPrivate: false };
                const serverTypeBadge = s.IsPrivate 
                    ? `<span class="badge badge-private">üîí Private</span>` 
                    : `<span class="badge badge-public">üåç Public</span>`;

                return `
                <div class="card ${b.userType === 'LocalPlayer' ? 'is-local' : ''}">
                    <div class="income">${b.incomeStr}</div>
                    <div class="rarity ${b.rarity}">${b.rarity}</div>
                    <div class="name">${b.name}</div>
                    <div class="mutation">‚ú® ${b.mutation}</div>
                    
                    <div class="traits-list">
                        ${b.traits && b.traits.length > 0 ? b.traits.map(t => `<span class="trait-tag">#${t}</span>`).join('') : '<span class="trait-tag" style="opacity:0.5">Aucun trait</span>'}
                    </div>

                    <div class="footer">
                        <span class="timestamp">‚è± ${timeAgo(b.updatedAt)}</span>
                        <span class="badge ${b.userType === 'LocalPlayer' ? 'badge-local' : 'badge-user'}">${b.userType}</span>
                        üë§ <b>${b.ownerDisplayName}</b> (@${b.ownerName})<br>
                        üìÖ ${b.accountAge}j | ${serverTypeBadge}
                        
                        <span class="server-info">
                            üë• Joueurs: ${s.PlayerCount}/${s.MaxPlayers}<br>
                            üîë ID: ${b.jobId.substring(0,12)}...
                        </span>
                        
                        <a href="roblox://experiences/start?placeId=109983668079237&gameInstanceId=${b.jobId}" class="join-btn">
                            üöÄ JOIN SERVER
                        </a>
                    </div>
                </div>
            `}).join('');
        }

        setInterval(render, 5000);
    </script>
</body>
</html>
