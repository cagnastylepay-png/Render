<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M4GIX Control Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0b0f1a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .card { background-color: #161e2d; border: 1px solid #1e293b; transition: all 0.2s; }
        .card:hover { border-color: #3b82f6; }
        .search-input { background: #0f172a; border: 1px solid #334155; }
        .search-input:focus { border-color: #3b82f6; outline: none; }
        .view-btn-active { background-color: #3b82f6; color: white; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        table { border-collapse: separate; border-spacing: 0 4px; }
    </style>
</head>
<body class="p-6">
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
        <div>
            <h1 class="text-2xl font-black tracking-tighter text-blue-500 italic">M4GIX <span class="text-white">HUB</span></h1>
            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Advanced Monitoring System</p>
        </div>
        
        <div class="flex flex-1 justify-center gap-2">
            <div class="relative w-full max-w-md">
                <input type="text" id="global-search" oninput="applyFilter()" placeholder="Rechercher nom, raretÃ©, trait..." 
                       class="search-input w-full px-4 py-2 rounded text-sm text-slate-200">
            </div>
            <div class="flex border border-slate-700 rounded overflow-hidden p-1 bg-slate-900/50">
                <button onclick="setView('cards')" id="btn-cards" class="px-3 py-1 text-[10px] font-bold uppercase rounded transition view-btn-active">Cards</button>
                <button onclick="setView('list')" id="btn-list" class="px-3 py-1 text-[10px] font-bold uppercase rounded transition text-slate-400">List</button>
            </div>
        </div>

        <button onclick="clearDB()" class="text-[10px] bg-red-600/10 text-red-500 border border-red-600/30 px-4 py-2 rounded hover:bg-red-600 hover:text-white transition font-bold">CLEAR DATABASE</button>
    </header>

    <div id="stats-bar" class="mb-6 flex gap-4">
        <div class="bg-blue-600/10 border border-blue-600/20 px-4 py-2 rounded">
            <span class="text-[10px] text-slate-500 uppercase block">Players</span>
            <span id="player-count" class="text-xl font-black text-blue-400">0</span>
        </div>
    </div>

    <div id="main-display"></div>

    <script>
        let allPlayers = [];
        let currentView = 'cards';

        const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${protocol}://${window.location.host}?role=Admin`);

        ws.onmessage = (event) => {
            const payload = JSON.parse(event.data);
            if (payload.type === 'REFRESH') {
                allPlayers = payload.data;
                applyFilter();
            }
        };

        function setView(view) {
            currentView = view;
            document.getElementById('btn-cards').classList.toggle('view-btn-active', view === 'cards');
            document.getElementById('btn-list').classList.toggle('view-btn-active', view === 'list');
            applyFilter();
        }

        function applyFilter() {
            const query = document.getElementById('global-search').value.toLowerCase();
            const filtered = allPlayers.filter(p => {
                if (!query) return true;
                const pMatch = p.name.toLowerCase().includes(query) || p.displayName.toLowerCase().includes(query);
                const bMatch = (p.brainrots || []).some(br => 
                    br.Name.toLowerCase().includes(query) || 
                    br.Mutation.toLowerCase().includes(query) || 
                    br.Rarity.toLowerCase().includes(query)
                );
                return pMatch || bMatch;
            });

            currentView === 'cards' ? renderCards(filtered) : renderList(filtered);
        }

        function renderCards(players) {
            document.getElementById('player-count').innerText = players.length;
            const container = document.getElementById('main-display');
            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">${
                players.map(player => `
                    <div class="card p-5 rounded">
                        <div class="flex justify-between items-start mb-4 border-b border-slate-800 pb-2">
                            <div>
                                <h3 class="text-blue-400 font-black text-lg">${player.displayName}</h3>
                                <span class="text-[9px] text-slate-500 font-mono">@${player.name}</span>
                            </div>
                            <button onclick="deletePlayer(${player.userId})" class="text-[9px] text-red-500 font-bold hover:underline">DELETE</button>
                        </div>
                        <div class="space-y-2">
                            ${(player.brainrots || []).map(br => `
                                <div class="bg-black/30 p-2 rounded text-[11px] flex justify-between border border-slate-800/30">
                                    <span class="font-bold text-white uppercase">${br.Name}</span>
                                    <span class="text-emerald-400 font-mono">${br.IncomeStr}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')
            }</div>`;
        }

        function renderList(players) {
            // Aplatir tous les brainrots dans un seul tableau pour la vue liste
            const allBrainrots = [];
            players.forEach(p => {
                (p.brainrots || []).forEach(br => {
                    allBrainrots.push({ ...br, playerName: p.displayName, playerUser: p.name });
                });
            });

            // Trier par revenu descendant
            allBrainrots.sort((a,b) => (b.Income || 0) - (a.Income || 0));

            const container = document.getElementById('main-display');
            container.innerHTML = `
                <div class="overflow-x-auto bg-[#161e2d] rounded border border-slate-800">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-black/40 text-slate-400 font-bold uppercase">
                            <tr>
                                <th class="p-4">Owner</th>
                                <th class="p-4">Brainrot</th>
                                <th class="p-4">Mutation</th>
                                <th class="p-4">Rarity</th>
                                <th class="p-4">Income</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allBrainrots.map(br => `
                                <tr class="hover:bg-blue-600/5 transition border-t border-slate-800/50">
                                    <td class="p-4 font-bold text-blue-400">${br.playerName} <span class="text-[9px] text-slate-500 block">@${br.playerUser}</span></td>
                                    <td class="p-4 text-white font-bold uppercase">${br.Name}</td>
                                    <td class="p-4"><span class="bg-purple-500/10 text-purple-400 px-2 py-0.5 rounded border border-purple-500/20">${br.Mutation}</span></td>
                                    <td class="p-4 font-bold text-slate-400">${br.Rarity}</td>
                                    <td class="p-4 font-mono text-emerald-400 font-bold">${br.IncomeStr}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function deletePlayer(userId) {
            if(confirm("Supprimer ce joueur ?")) await fetch(`/api/client/${userId}`, { method: 'DELETE' });
        }

        async function clearDB() {
            if(confirm("Vider toute la base ?")) await fetch('/api/clear-database', { method: 'POST' });
        }
    </script>
</body>
</html>
